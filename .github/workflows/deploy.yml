name: Deploy Localpay API Prod

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up AWS CLI (for master only)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      
      - name: Get EC2 Public IP by Tag 
        run: |
            IP_LIST=$(aws ec2 describe-instances \
              --region me-central-1 \
              --filters "Name=tag:Name,Values=localpay-production-zz" "Name=instance-state-name,Values=running" \
              --output json | jq -r '.Reservations[].Instances[].PublicIpAddress')
  
            IP_CSV=$(echo "$IP_LIST" | paste -sd "," -)
  
            echo "Resolved EC2 IPs: $IP_CSV"
            echo "EC2_PUBLIC_IP=$IP_CSV" >> $GITHUB_ENV

      - name: Run composer and build on build server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ls -la ~/.ssh
          cat ~/.ssh/id_rsa | head -n 5
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.BUILD_SERVER_IP }} <<'EOF'
           set -e
           sudo apt update
           sudo apt install -y software-properties-common
           sudo add-apt-repository -y ppa:ondrej/php
           sudo apt update
           sudo apt install -y php8.2 php8.2-cli php8.2-mbstring php8.2-pgsql php8.2-fpm php8.2-curl unzip curl composer nginx

            cd /var/www/html/localpay-api/

            composer install --no-dev --optimize-autoloader
            #backend file name 
            echo "${{ secrets.PRODUCTION_BACKEND_ENV }}" > .env  
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            mkdir -p ~/builds
            tar --exclude='.git' -czf ~/builds/localpay-api.tar.gz .
          EOF

      - name: Download artifact from build server to runner 
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.BUILD_SERVER_IP }}:~/builds/localpay-api.tar.gz .


      - name: Deploy to Production EC2s
        run: |
          IFS=',' read -ra IP_ARRAY <<< "$EC2_PUBLIC_IP"


          for ip in "${IP_ARRAY[@]}"; do
            echo "ðŸ“¦ Uploading to $ip"
            scp -C -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no localpay-api.tar.gz ubuntu@$ip:/tmp/

            echo "ðŸš€ Deploying to $ip"
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$ip <<'EOF'
              set -e
            #   sudo apt update
            #   sudo apt install -y php php-cli php-mbstring unzip curl php-pgsql nginx php-fpm

              mkdir -p /var/www/html/localpay-api
              tar -xzf /tmp/localpay-api.tar.gz -C /var/www/html/localpay-api --strip-components=1

            #   sudo chown -R www-data:www-data /var/www/html/localpay-api
            #   sudo chmod -R 755 /var/www/html/localpay-api

            #   sudo cp /var/www/html/localpay-api/deploy/nginx.conf /etc/nginx/sites-available/localpay-api
            #   sudo ln -sf /etc/nginx/sites-available/localpay-api /etc/nginx/sites-enabled/localpay-api
            #   sudo rm -f /etc/nginx/sites-enabled/default

              cd /var/www/html/localpay-api
            #   php artisan migrate

            #   sudo systemctl reload php8.2-fpm
            #   sudo systemctl restart nginx
            EOF
          done
