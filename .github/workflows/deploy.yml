name: Laravel Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get EC2 Public IPs
        id: ec2
        run: |
          IP_LIST=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=laravel-prod" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)
          echo "EC2_PUBLIC_IPS=$IP_LIST" >> $GITHUB_ENV

      - name: Set up SSH access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Trigger Build on Build EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.BUILD_SERVER_IP }} "bash -s" <<'EOF'
            set -e
            sudo apt update
            sudo apt install -y php php-cli php-mbstring unzip curl php-pgsql composer nginx php-fpm

            cd /var/www/laravel-app || git clone git@github.com:your-username/your-laravel-repo.git /var/www/laravel-app && cd /var/www/laravel-app

            git pull origin master

            composer install --no-dev --optimize-autoloader
            cp .env.production .env
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            mkdir -p ~/builds
            tar --exclude='.git' -czf ~/builds/laravel-app.tar.gz .
          EOF

      - name: Copy Build Artifact from Build EC2
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.BUILD_SERVER_IP }}:~/builds/laravel-app.tar.gz .

      - name: Deploy to Production EC2s
        run: |
          IFS=' ' read -ra IP_ARRAY <<< "$EC2_PUBLIC_IPS"

          for ip in "${IP_ARRAY[@]}"; do
            echo "ðŸ“¦ Uploading to $ip"
            scp -C -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no laravel-app.tar.gz ubuntu@$ip:/tmp/

            echo "ðŸš€ Deploying to $ip"
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$ip "bash -s" <<'EOF'
              sudo apt update
              sudo apt install -y php php-cli php-mbstring unzip curl php-pgsql nginx php-fpm

              mkdir -p /var/www/laravel-app
              tar -xzf /tmp/laravel-app.tar.gz -C /var/www/laravel-app --strip-components=1

              sudo chown -R www-data:www-data /var/www/laravel-app
              sudo chmod -R 755 /var/www/laravel-app

              sudo cp /var/www/laravel-app/deploy/nginx.conf /etc/nginx/sites-available/laravel
              sudo ln -sf /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/laravel
              sudo rm -f /etc/nginx/sites-enabled/default

              sudo systemctl reload php8.2-fpm
              sudo systemctl restart nginx
            EOF
          done
