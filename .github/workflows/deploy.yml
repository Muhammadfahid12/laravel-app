name: Deploy Localpay API Prod
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Clear AWS CLI cache
      run: rm -rf ~/.aws/cli/cache

    - name: Verify AWS identity
      run: aws sts get-caller-identity

    - name: Get EC2 Public IPs by tag
      run: |
        IP_LIST=$(aws ec2 describe-instances \
          --region us-east-1 \
          --filters "Name=tag:Name,Values=localpay-production-zz" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].PublicIpAddress' \
          --output text)
        IP_CSV=$(echo "$IP_LIST" | paste -sd "," -)
        echo "EC2_PUBLIC_IP=$IP_CSV" >> $GITHUB_ENV

    # â”€â”€â”€â”€â”€ BUILD SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create source archive
      run: |
        git ls-files -z | tar --null -T - -czf source.tar.gz

    - name: Push to build server
      run: |
        mkdir -p ~/.ssh
        echo "${{secrets.SSH_PRIVATE_KEY}}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa 
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          source.tar.gz ubuntu@${{ secrets.BUILD_SERVER_IP }}:/tmp/

    - name: Build on server
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.BUILD_SERVER_IP }} <<'SSH'
        set -e
        if ! command -v nginx >/dev/null; then
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
          sudo apt-get install -y nginx php8.2 php8.2-{cli,fpm,mbstring,pgsql,curl,xml,zip,bcmath,intl} unzip curl composer
          sudo systemctl enable nginx php8.2-fpm
        fi
        
        sudo mkdir -p /var/www/html/localpay-api
        sudo tar -xzf /tmp/source.tar.gz -C /var/www/html/localpay-api
        sudo chown -R ubuntu:ubuntu /var/www/html/localpay-api
        
        cd /var/www/html/localpay-api
        echo "${{ secrets.PRODUCTION_BACKEND_ENV }}" > .env
        composer install --no-dev --optimize-autoloader
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        
        mkdir -p ~/builds
        tar -czf ~/builds/localpay-api.tar.gz .
        SSH

    - name: Download artifact
      run: |
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ubuntu@${{ secrets.BUILD_SERVER_IP }}:~/builds/localpay-api.tar.gz .

    # â”€â”€â”€â”€â”€ DEPLOY SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Deploy to EC2s
      env:
        EC2_PUBLIC_IP: ${{ env.EC2_PUBLIC_IP }}
      run: |
        IFS=',' read -ra IP_ARRAY <<< "$EC2_PUBLIC_IP"
        for ip in "${IP_ARRAY[@]}"; do
          echo "ðŸ“¦ Deploying to the $ip"
          scp -C -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            localpay-api.tar.gz ubuntu@$ip:/tmp/

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$ip <<'SSH'
        set -e
        sudo mkdir -p /var/www/html/localpay-api/deploy
        if [ ! -f /var/www/html/localpay-api/deploy/nginx.conf ]; then
          cat <<EOF | sudo tee /var/www/html/localpay-api/deploy/nginx.conf
        server {
            listen 80;
            server_name _;
            root /var/www/html/localpay-api/public;
            index index.php;
            
            location / {
                try_files \$uri \$uri/ /index.php?\$query_string;
            }
            
            location ~ \.php$ {
                fastcgi_pass unix:/run/php/php8.2-fpm.sock;
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
            }
        }
        EOF
        fi
        if ! command -v nginx >/dev/null; then
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
          sudo apt-get install -y nginx php8.2 php8.2-fpm php8.2-cli php8.2-{mbstring,curl,pgsql,xml,zip,bcmath,intl}
          sudo systemctl enable nginx php8.2-fpm
        fi
        
        sudo mkdir -p /var/www/html/localpay-api
        sudo tar -xzf /tmp/localpay-api.tar.gz -C /var/www/html/localpay-api --strip-components=1
        sudo chown -R www-data:www-data /var/www/html/localpay-api
        sudo chmod -R 755 /var/www/html/localpay-api
        sudo chmod -R 755 /var/www/html/localpay-api/*

        
        sudo cp /var/www/html/localpay-api/deploy/nginx.conf /etc/nginx/sites-available/localpay-api
        sudo sed -i 's#fastcgi_pass .*;#fastcgi_pass unix:/run/php/php8.2-fpm.sock;#' /etc/nginx/sites-available/localpay-api
        sudo ln -sf /etc/nginx/sites-available/localpay-api /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/default
        
        cd /var/www/html/localpay-api
        php artisan migrate --force --no-interaction
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        
        sudo systemctl reload php8.2-fpm
        sudo systemctl restart nginx
        SSH
        done

      # - name: Deploy to Production EC2s
      #   run: |
      #     IFS=',' read -ra IP_ARRAY <<< "$EC2_PUBLIC_IP"


      #     for ip in "${IP_ARRAY[@]}"; do
      #       echo "ðŸ“¦ Uploading to $ip"
      #       scp -C -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no localpay-api.tar.gz ubuntu@$ip:/tmp/

      #       echo "ðŸš€ Deploying to $ip"
      #       ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$ip <<'EOF'
      #         set -e
      #       #   sudo apt update
      #       #   sudo apt install -y php php-cli php-mbstring unzip curl php-pgsql nginx php-fpm

      #         mkdir -p /var/www/html/localpay-api
      #         tar -xzf /tmp/localpay-api.tar.gz -C /var/www/html/localpay-api --strip-components=1

      #       #   sudo chown -R www-data:www-data /var/www/html/localpay-api
      #       #   sudo chmod -R 755 /var/www/html/localpay-api

      #       #   sudo cp /var/www/html/localpay-api/deploy/nginx.conf /etc/nginx/sites-available/localpay-api
      #       #   sudo ln -sf /etc/nginx/sites-available/localpay-api /etc/nginx/sites-enabled/localpay-api
      #       #   sudo rm -f /etc/nginx/sites-enabled/default

      #         cd /var/www/html/localpay-api
      #       #   php artisan migrate

      #       #   sudo systemctl reload php8.2-fpm
      #       #   sudo systemctl restart nginx
      #       EOF
      #     done
